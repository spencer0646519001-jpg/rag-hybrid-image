<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>RAG MVP – Search</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg1:#ffd1a6; --bg2:#ffc0ad;
      --card:#ffffff; --text:#1f2937; --muted:#6b7280; --accent:#111827;
      --chip:#f3f4f6; --chipText:#111827; --chipBorder:#e5e7eb;
      --btn:#111827; --btnText:#fff; --radius:16px; --shadow:0 10px 28px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--text);
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
      padding:18px;
    }
    .wrap{max-width:1100px; margin:0 auto}
    .topbar{display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:14px}
    .brand{font-weight:800; font-size:20px; letter-spacing:.2px}
    .btn{
      border:none; border-radius:999px; padding:8px 12px; cursor:pointer; font-weight:600; transition:.15s transform ease;
    }
    .btn:active{transform:translateY(1px)}
    .btn-ghost{background:#fff; border:1px solid #e5e7eb}
    .btn-primary{background:var(--btn); color:var(--btnText)}
    select, input{
      border:1px solid #e5e7eb; background:#fff; border-radius:10px; padding:10px 12px; outline:none;
      font-size:14px;
    }
    .layout{display:grid; grid-template-columns: 1.6fr .9fr; gap:16px}
    .card{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .list{display:grid; gap:10px}
    .hit{border:1px solid #f1f5f9; border-radius:14px; padding:12px; background:#fff}
    .hit h4{margin:0 0 6px; font-size:15px}
    .hit .meta{display:flex; gap:8px; flex-wrap:wrap; color:#64748b; font-size:12px}
    .hit .score{font-weight:700}
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      display:inline-flex; align-items:center; gap:6px; padding:7px 11px; border-radius:999px; cursor:pointer;
      background:var(--chip); color:var(--chipText); border:1px solid var(--chipBorder); font-size:13px;
    }
    .chip:hover{background:#eef2ff; border-color:#c7d2fe}
    .divider{height:1px; background:#f1f5f9; margin:12px 0}
    .error{background:#fee2e2; color:#b91c1c; padding:10px 12px; border-radius:10px; border:1px solid #fecaca; font-size:13px; display:none}
    .empty{color:var(--muted); font-size:14px}
    .answer{white-space:pre-wrap; line-height:1.5}
    .pagination{display:flex; gap:8px; align-items:center}
    #status{font-size:12px; color:#64748b}
    @media (max-width: 980px){ .layout{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">RAG MVP</div>
      <div id="status">ready</div>
    </div>

    <div class="layout">
      <!-- LEFT: 搜尋 + 結果 + 回答 -->
      <div class="card">
        <div class="row">
          <input id="q" style="flex:1" placeholder="關鍵字（例：抹茶, macaron）" />
          <select id="docLang">
            <option value="zh">中文</option>
            <option value="en" selected>English</option>
            <option value="ja">日本語</option>
          </select>
          <input id="minScore" type="number" value="20" title="最低分數" style="width:90px" />
          <input id="perPage"  type="number" value="5"  title="每頁筆數" style="width:90px" />
          <button class="btn btn-primary" id="btnSearch">搜尋</button>
        </div>

        <div id="error" class="error"></div>
        <div id="results" class="list" style="margin-top:10px"></div>

        <div class="pagination" style="margin-top:10px">
          <button class="btn btn-ghost" id="prev">◀ 上一頁</button>
          <button class="btn btn-ghost" id="next">下一頁 ▶</button>
          <span id="pageInfo" style="color:#64748b; font-size:13px"></span>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div style="display:flex; gap:8px; align-items:center">
            <strong>Answer</strong>
            <label>max chars <input id="maxChars" type="number" value="300" style="width:90px"></label>
            <label>order
              <select id="ansOrder">
                <option value="max" selected>max</option>
                <option value="avg">avg</option>
              </select>
            </label>
            <label>use LLM
              <select id="useLLM">
                <option value="true" selected>true</option>
                <option value="false">false</option>
              </select>
            </label>
          </div>
          <button class="btn btn-primary" id="btnAnswer">產生回答</button>
        </div>

        <div id="answerBox" class="answer" style="margin-top:8px"></div>
        <div id="citeBox"   style="margin-top:6px; font-size:12px; color:#64748b"></div>
      </div>

      <!-- RIGHT: 熱門標籤 / 語言分布（選修，之後再做） -->
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <strong>熱門標籤（之後接 /tags）</strong>
          <span style="color:#94a3b8">coming soon</span>
        </div>
        <div class="divider"></div>
        <div class="row" style="justify-content:space-between">
          <strong>語言分布（之後接 /languages）</strong>
          <span style="color:#94a3b8">coming soon</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- 1) API base ---
    const API_BASE = "http://127.0.0.1:8000";

    // --- 2) Helpers ---
    const $ = (id)=>document.getElementById(id);
    function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
    async function jget(path, query){
      const qs = new URLSearchParams(query||{}).toString();
      const url = `${API_BASE}${path}${qs ? `?${qs}` : ""}`;
      const r = await fetch(url, { headers: { "accept":"application/json" }});
      if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
      return r.json();
    }
    function setError(msg){
      const box = $("error");
      if (!msg){ box.style.display="none"; box.textContent=""; return; }
      box.textContent = msg; box.style.display = "block";
    }
    function setStatus(s){ $("status").textContent = s; }

    // --- 3) State ---
    let offset = 0;
    function limit(){ return Math.max(1, parseInt($("perPage").value||"5", 10)); }
    function minScore(){ return Math.max(0, parseInt($("minScore").value||"0", 10)); }

    // --- 4) Render results ---
    function renderResults(data){
      const box = $("results");
      box.innerHTML = "";
      const items = data.items || [];
      if (!items.length){
        box.innerHTML = `<div class="empty">沒有結果</div>`;
        $("pageInfo").textContent = "";
        return;
      }
      const frag = document.createDocumentFragment();
      for (const h of items){
        const div = document.createElement("div");
        div.className = "hit";
        const tags = (h.tags||[]).map(t=>`<span class="chip">${escapeHtml(t)}</span>`).join("");
        div.innerHTML = `
          <h4>${escapeHtml(h.title)}</h4>
          <div style="color:#334155; font-size:13px; margin-bottom:8px">${escapeHtml(h.snippet||"")}</div>
          <div class="meta">
            <span class="score">⭐ ${Math.round(h.score)}</span>
            <span>lang: ${escapeHtml(h.lang||"")}</span>
            <span>matched_on: ${escapeHtml(h.matched_on||"")}</span>
          </div>
          <div class="chips" style="margin-top:6px">${tags}</div>
        `;
        frag.appendChild(div);
      }
      box.appendChild(frag);

      const total = data.total || 0;
      const page  = Math.floor(offset/limit())+1;
      const maxP  = Math.max(1, Math.ceil(total/limit()));
      $("pageInfo").textContent = `第 ${page} / 共 ${maxP} 頁（${total} 筆）`;
    }

    // --- 5) Actions ---
    async function runSearch(){
      try{
        setError(""); setStatus("searching…");
        const data = await jget("/search", {
          q: $("q").value.trim(),
          lang: $("docLang").value,
          min_score: minScore(),
          offset,
          limit: limit(),
          mode: "hybrid",      // 先用 hybrid（你後端支援 text/vector/hybrid）
          w_text: 0.5,         // 可調
          w_vec:  0.5
        });
        renderResults(data);
        setStatus("ready");
      }catch(e){
        setStatus("ready");
        setError("Search failed: " + e.message);
      }
    }

    async function runAnswer(){
      try{
        setError(""); setStatus("answering…");
        $("answerBox").textContent = "";
        $("citeBox").textContent   = "";
        const data = await jget("/answer", {
          q: $("q").value.trim(),
          lang: $("docLang").value,
          top_k: 3,
          max_chars: Math.max(80, parseInt($("maxChars").value||"300", 10)),
          order: $("ansOrder").value,
          use_llm: $("useLLM").value
        });
        $("answerBox").textContent = data.answer || "(no answer)";
        const used = data.used_llm ? "LLM✅" : "LLM❌(fallback)";
        const cites = (data.citations||[]).map(c=>`${c.title} [${Math.round(c.score||0)}]`).join(" | ");
        $("citeBox").textContent = `${used} ｜ ${cites}`;
        setStatus("ready");
      }catch(e){
        setStatus("ready");
        setError("Answer failed: " + e.message);
      }
    }

    // --- 6) Events ---
    $("btnSearch").addEventListener("click", ()=>{ offset=0; runSearch(); });
    $("prev").addEventListener("click", ()=>{ offset=Math.max(0, offset-limit()); runSearch(); });
    $("next").addEventListener("click", ()=>{ offset+=limit(); runSearch(); });
    $("btnAnswer").addEventListener("click", runAnswer);
    $("q").addEventListener("keydown", e=>{ if(e.key==="Enter"){ offset=0; runSearch(); } });

    // --- 7) Init ---
    $("q").value = "抹茶, macaron";
    runSearch();
  </script>
</body>
</html>
